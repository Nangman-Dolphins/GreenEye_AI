# 🌿 AI 기반 식물 질병 진단 모델

이 저장소는 식물 이미지를 분석하여 질병을 진단하는 딥러닝 모델의 학습 및 추론 파이프라인 코드를 포함합니다. PyTorch와 PyTorch Lightning을 기반으로 하며, LoRA 파인튜닝과 고급 추론 기법을 통해 높은 정확도를 목표로 합니다.

---

## 🤖 AI 모델 아키텍처 및 학습 전략

### 1. 기반 모델 학습 (`model.py`)

* **기반 아키텍처**: ImageNet으로 사전 학습된 **ResNet50**을 기반 모델로 사용합니다.
* **학습 프레임워크**: **PyTorch Lightning**을 채택하여 코드의 재사용성과 가독성을 높이고, 학습 과정을 표준화했습니다. `pl.LightningModule`과 `pl.LightningDataModule`을 통해 모델과 데이터를 명확하게 분리하여 관리합니다.
* **학습 기법**:
    * **점진적 동결 해제(Progressive Unfreezing)**: 학습 초기에는 모델의 뒷단(FC Layer)만 학습시키고, 지정된 에포크(`unfreeze_start_epoch`)부터 전체 모델을 미세 조정하여 안정적인 학습을 유도합니다.
    * **데이터 증강**: `TrivialAugmentWide`를 기본으로 사용하며, `CutMix`와 `MixUp`을 선택적으로 적용하여 모델의 일반화 성능을 향상시킵니다.
    * **최적화**: AdamW 옵티마이저와 Cosine Annealing 스케줄러를 Warmup과 함께 사용하여 최적의 학습률을 찾아갑니다.

---

### 2. LoRA 파인튜닝 및 K-Fold 교차 검증 (`lora_finetuning.py`)

* **파인튜닝 기법**: **LoRA (Low-Rank Adaptation)**를 적용하여, 사전 학습된 기반 모델의 가중치는 대부분 동결한 채 소수의 파라미터만으로 특정 식물 데이터셋에 효율적으로 적응(fine-tuning)시킵니다.
* **K-Fold 교차 검증**: 데이터셋을 여러 개의 Fold로 나누어 학습과 검증을 반복합니다. 이를 통해 모델이 특정 데이터셋에 과적합되는 것을 방지하고, 더 안정적이고 신뢰도 높은 성능을 확보합니다.
* **손실 함수**: 클래스 불균형 문제를 완화하기 위해 **Focal Loss**를 사용하여, 학습이 어려운 샘플(소수 클래스 등)에 더 집중하도록 유도합니다.
* **데이터 전처리 유틸리티**: 학습 데이터의 품질을 높이기 위해 이미지 해시(ImageHash)를 이용해 중복되거나 매우 유사한 이미지를 사전에 찾아 제거하는 스크립트를 포함합니다.

---

## 🔬 고급 추론 파이프라인 (`inference.py`)

실시간성보다 정확도에 더 집중하여 파이프라인을 작성해보았습니다.

### 1. 타일링 (Tiling)

* 고해상도의 이미지를 일정 크기(`TILE_SIZE`)의 작은 타일로 분할합니다.
* 각 타일을 개별적으로 분석하여, 이미지의 특정 영역에만 나타나는 미세한 질병의 징후도 놓치지 않고 포착합니다.

### 2. TTA (Test-Time Augmentation)

* 추론 시에도 데이터 증강 기법을 적용하여 모델의 예측 안정성을 높입니다.
* **5-Crop**: 각 타일의 중앙과 네 모서리를 잘라내어 총 5개의 이미지를 얻습니다.
* **Horizontal Flip**: 원본과 좌우 반전된 이미지를 모두 추론에 사용합니다.
* 결과적으로 하나의 타일에서 총 10개(5개 Crop x 2개 Flip)의 예측 결과를 얻습니다.

### 3. 앙상블 및 결과 집계 (Ensemble & Aggregation)

* **K-Fold 모델 앙상블 (Ensemble)**: 단일 모델이 아닌, K-Fold 교차 검증으로 학습된 **여러 Fold 모델들을 모두 추론에 사용**합니다. 각 모델이 독립적으로 예측한 확률 결과를 평균내어(Soft Voting), 최종 진단을 내립니다. 이를 통해 모델의 일반화 성능을 극대화하고 단일 모델의 편향을 줄입니다.
* **타일 및 TTA 결과 집계**: 각 개별 모델은 수많은 타일과 TTA로부터 얻어진 예측 결과(logits)를 신뢰도가 높은 상위 K개의 결과만 평균(`topk_mean`)하여 하나의 종합된 예측을 만듭니다.
* 이 2단계 집계 과정을 통해, 특정 타일의 노이즈나 단일 모델의 오진 가능성을 최소화하고 매우 안정적이고 신뢰도 높은 최종 진단 결과를 도출합니다.